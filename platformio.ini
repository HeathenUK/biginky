; PlatformIO Project Configuration File
;
;   Build options: build flags, source filter
;   Upload options: custom upload port, speed and extra flags
;   Library options: dependencies, extra library storages
;   Advanced options: extra scripting
;
; Please visit documentation for the other options and examples
; https://docs.platformio.org/page/projectconf.html

[platformio]
boards_dir = boards

; ============================================================================
; ESP32-P4 Configuration
; ============================================================================
; Uses pioarduino platform 55.03.34 which includes ESP32-P4 support
; with arduino-esp32 3.3.4 based on ESP-IDF 5.5
;
; Pin mapping must be adjusted for your specific ESP32-P4-WIFI6 board.
; PSRAM: ESP32-P4 supports up to 32MB PSRAM (Octal mode @ 200MHz)
; ============================================================================

[env:esp32p4]
platform = https://github.com/pioarduino/platform-espressif32/releases/download/55.03.34/platform-espressif32.zip
board = esp32p4_wifi6
framework = arduino

; Custom board definition in boards/ folder

; Use custom partition table with larger app partition (32MB flash)
board_build.partitions = partitions.csv
board_build.flash_size = 32MB
; Use sdkconfig.defaults to ensure ESP-IDF configs are applied
board_build.sdkconfig_path = sdkconfig.defaults

; Build configuration
build_unflags = -Os
build_flags = 
	-O2
	-DEL133UF1_SPI_SPEED=80000000
	-DUSE_PSRAM=1
	-DBOARD_HAS_PSRAM
	; Disable ESP8266Audio MIDI support (has compilation errors on ESP32-P4)
	; Note: MIDI files are excluded via pre-build script (no source modification needed)
	; Enable WiFi (via ESP32-C6 companion chip, ESP-Hosted over SDIO)
	-DENABLE_WIFI_TEST=1
	; Enable HTTPS server support (PsychicHttp - matches example)
	-DPSY_ENABLE_SSL
	; Force enable ESP-IDF HTTPS config (required for PsychicHttpsServer)
	-DCONFIG_ESP_HTTPS_SERVER_ENABLE=1
	-DCONFIG_HTTPD_WS_SUPPORT=1
	; Increase HTTP request body size limit for canvas uploads
	-DCONFIG_HTTPD_MAX_REQ_HDR_LEN=4096
	-DCONFIG_HTTPD_MAX_URI_LEN=2048
	; Note: CONFIG_HTTPD_TASK_STACK_SIZE is set in sdkconfig.defaults (not a build flag)
	; Flash configuration (32MB) - from sdkconfig.defaults
	-DCONFIG_BOOTLOADER_CACHE_32BIT_ADDR_FLASH=1
	-DCONFIG_BOOTLOADER_CACHE_32BIT_ADDR_QUAD_FLASH=1
	-DCONFIG_BOOTLOADER_CACHE_32BIT_ADDR_OCTAL_FLASH=1
	; PSRAM configuration - 16-bit mode at 200MHz (from sdkconfig.defaults)
	-DCONFIG_SPIRAM=1
	-DCONFIG_SPIRAM_MODE_HEX=1
	-DCONFIG_SPIRAM_SPEED_200M=1
	; FATFS/exFAT support - from sdkconfig.defaults
	-DCONFIG_FATFS_LFN_HEAP=1
	-DCONFIG_FATFS_MAX_LFN=255
	-DCONFIG_FATFS_USE_LABEL=1
	; SDMMC support - from sdkconfig.defaults
	-DCONFIG_SOC_SDMMC_HOST_SUPPORTED=1
	; Disable display for faster iteration (comment to enable display)
	; -DDISABLE_DISPLAY=1
	; ESP32-P4-WIFI6 pin definitions - MATCHES PICO PHYSICAL LOCATIONS
	; Mapping: Pico GPxx -> ESP32-P4 GPIOyy (same physical pin)
	; SPI for display
	-DPIN_SPI_SCK=3      ; GP10 -> GPIO3 (pin 14)
	-DPIN_SPI_MOSI=2     ; GP11 -> GPIO2 (pin 15)
	-DPIN_CS0=23         ; GP26 -> GPIO23 (pin 31)
	-DPIN_CS1=48         ; GP16 -> GPIO48 (pin 21)
	-DPIN_DC=26          ; GP22 -> GPIO26 (pin 29)
	-DPIN_RESET=22       ; GP27 -> GPIO22 (pin 32)
	-DPIN_BUSY=47        ; GP17 -> GPIO47 (pin 22)
	; RTC pins (unused - using ESP32 internal RTC)
	-DPIN_RTC_SDA=31     ; GP2 -> GPIO31 (pin 4)
	-DPIN_RTC_SCL=30     ; GP3 -> GPIO30 (pin 5)
	-DPIN_RTC_INT=5      ; LP GPIO for deep sleep wake
	; -DPIN_SW_D_BRIDGE=4  ; GPIO51 bridged to GPIO4 for Switch D deep sleep wake (DISABLED)

build_src_filter = 
	+<*>

lib_ignore = 
	pico_sleep
	DS3231
	esp32_sleep

monitor_speed = 115200

lib_deps = 
	kikuchan98/pngle@^1.1.0
	earlephilhower/ESP8266Audio@^1.9.9
	bblanchon/ArduinoJson@^7.0.0
	hoeken/PsychicHttp@^2.1.1

; Pre-build scripts
; 1. Regenerate color LUT if palette changes
; 2. Exclude ESP8266Audio MIDI files (removes files, no source modification)
; 3. Generate self-signed certificate and create header file (if needed)
; 4. Generate web assets header from web/index.html
; 5. Ensure HTTPS configs are in sdkconfig before ESP-IDF processes it
extra_scripts = 
	pre:scripts/pre_build.py
	pre:scripts/fix_esp8266audio.py
	pre:scripts/generate_cert_header.py
	pre:scripts/generate_web_header.py
	pre:scripts/ensure_https_sdkconfig.py

build_type = release

; ============================================================================
; ESP32-P4 ESP-IDF Build (with exFAT support)
; ============================================================================
; Pure ESP-IDF for full sdkconfig control including exFAT filesystem

[env:esp32p4_espidf]
platform = https://github.com/pioarduino/platform-espressif32/releases/download/55.03.34/platform-espressif32.zip
board = esp32p4_wifi6
framework = espidf

build_flags = 
	-DPIN_SD_CLK=43
	-DPIN_SD_CMD=44
	-DPIN_SD_D0=39
	-DPIN_SD_D1=40
	-DPIN_SD_D2=41
	-DPIN_SD_D3=42
	-DPIN_SD_POWER=45

monitor_speed = 115200

build_type = release
