<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Device Management</title>
<style>
body{font-family:Arial,sans-serif;max-width:1200px;margin:0 auto;padding:20px;background:#1a1a1a;color:#e0e0e0;}
h1{color:#e0e0e0;border-bottom:2px solid #4CAF50;padding-bottom:10px;margin-top:60px;}
.header-controls{position:fixed;top:0;left:0;right:0;background:#2a2a2a;padding:10px 20px;z-index:1000;box-shadow:0 2px 8px rgba(0,0,0,0.3);display:flex;justify-content:space-between;align-items:center;}
.header-controls button{background:#f44336;color:white;border:none;padding:8px 16px;border-radius:4px;cursor:pointer;font-size:14px;font-weight:bold;width:40px;height:40px;display:flex;align-items:center;justify-content:center;}
.header-controls button.ota{background:#2196F3;width:auto;padding:8px 16px;}
.header-controls button:hover{opacity:0.9;}
.tabs{display:flex;gap:5px;margin:20px 0;border-bottom:2px solid #333;flex-wrap:wrap;}
.tab{background:#2a2a2a;color:#b0b0b0;border:none;padding:12px 24px;border-radius:8px 8px 0 0;cursor:pointer;font-size:16px;font-weight:bold;transition:all 0.2s;}
.tab:hover{background:#333;color:#e0e0e0;}
.tab.active{background:#1a1a1a;color:#4CAF50;border-bottom:3px solid #4CAF50;}
.tab-content{display:none;}
.tab-content.active{display:block;}
.section{background:#2a2a2a;padding:20px;margin:20px 0;border-radius:8px;box-shadow:0 2px 4px rgba(0,0,0,0.3);}
h2{color:#4CAF50;margin-top:0;}
textarea{width:100%;min-height:200px;font-family:monospace;padding:10px;border:1px solid #444;border-radius:4px;box-sizing:border-box;background:#1a1a1a;color:#e0e0e0;}
input[type="number"]{width:100px;padding:8px;border:1px solid #444;border-radius:4px;background:#1a1a1a;color:#e0e0e0;}
select{width:100%;padding:8px;border:1px solid #444;border-radius:4px;box-sizing:border-box;background:#1a1a1a;color:#e0e0e0;}
button{background:#4CAF50;color:white;border:none;padding:10px 20px;border-radius:4px;cursor:pointer;font-size:16px;margin:5px;}
button:hover{background:#45a049;}
button.delete{background:#f44336;padding:5px 10px;font-size:16px;width:30px;height:30px;min-width:30px;}
button.delete:hover{background:#d32f2f;}
.status{color:#4CAF50;margin:10px 0;font-weight:bold;}
.error{color:#f44336;}
label{display:block;margin:10px 0 5px 0;font-weight:bold;color:#e0e0e0;}
.form-group{margin:15px 0;}
td{padding:5px;}
table thead tr{background:#333 !important;}
table tbody tr{background:#2a2a2a;}
table tbody tr:hover{background:#333;}
input[type="checkbox"]{cursor:pointer;}
.quote-row{border-bottom:1px solid #444;padding:15px 0;margin-bottom:15px;}
.quote-row:last-child{border-bottom:none;}
.quote-text{margin-bottom:10px;}
.quote-author{color:#b0b0b0;font-style:italic;margin-top:5px;padding-top:10px;border-top:1px solid #444;}
.table-wrapper{overflow-x:auto;width:100%;}
canvas{max-width:100%;height:auto;}
@media (max-width:768px){
body{padding:10px;}
h1{margin-top:50px;font-size:20px;}
.section{padding:15px;}
.tab{padding:10px 15px;font-size:14px;}
button{font-size:14px;padding:8px 16px;}
.header-controls button.ota{font-size:12px;padding:6px 12px;}
table{font-size:14px;}
td{padding:8px 4px;}
}
</style>
</head>
<body>
<div class="header-controls">
<button onclick="closeServer()" title="Close Management Interface">‚úï</button>
<button class="ota" onclick="startOTA()">Start OTA Update Mode</button>
</div>
<h1>Device Configuration Management</h1>
<div class="tabs">
<button class="tab active" onclick="switchTab('draw')">Draw</button>
<button class="tab" onclick="switchTab('media')">Media</button>
<button class="tab" onclick="switchTab('config')">Config</button>
</div>
<div id="drawTab" class="tab-content active">
<div class="section"><h2>Text Display</h2>
<p>Enter text to display on the panel. Select a text colour (or "Multi" for random colours per word) and background colour.</p>
<label>Text:</label>
<textarea id="textInput" placeholder="Enter text to display..." style="width:100%;min-height:100px;padding:10px;border:1px solid #444;border-radius:4px;box-sizing:border-box;font-family:monospace;background:#1a1a1a;color:#e0e0e0;margin:10px 0;"></textarea>
<label style="margin-top:10px;">Text Colour:</label>
<select id="textColor" style="width:200px;margin-bottom:10px;">
<option value="black" selected>Black</option>
<option value="yellow">Yellow</option>
<option value="red">Red</option>
<option value="blue">Blue</option>
<option value="green">Green</option>
<option value="multi">Multi (Random Colours)</option>
<option value="multi-fade">Multi-Fade (Gradient)</option>
<option value="white">White</option>
</select>
<label style="margin-top:10px;">Background Colour:</label>
<select id="textBackgroundColor" style="width:200px;margin-bottom:10px;">
<option value="black">Black</option>
<option value="yellow">Yellow</option>
<option value="red">Red</option>
<option value="blue">Blue</option>
<option value="green">Green</option>
<option value="white" selected>White</option>
</select>
<button onclick="displayText()">Display Text on Panel</button>
<div id="textStatus"></div></div>
<div class="section"><h2>Drawing Canvas</h2>
<p>Draw on the canvas (800x600) and display it on the panel (1600x1200). The drawing will be scaled 2x and centered.</p>
<label>Colour:</label>
<select id="drawColor" style="width:150px;margin:10px 0;">
<option value="0" selected>Black</option>
<option value="2">Yellow</option>
<option value="3">Red</option>
<option value="5">Blue</option>
<option value="6">Green</option>
<option value="1">White</option>
</select>
<button onclick="clearCanvas()">Clear Canvas</button>
<button onclick="sendCanvasToDisplay()">Display on Panel</button>
<canvas id="drawCanvas" width="800" height="600" style="border:2px solid #666;cursor:crosshair;background:#fff;touch-action:none;margin-top:10px;display:block;max-width:100%;height:auto;"></canvas>
<div id="canvasStatus"></div></div>
</div>
<div id="mediaTab" class="tab-content">
<div class="section"><h2>Quotes Configuration (quotes.txt)</h2>
<p>Manage quotes and authors. Each quote must have an author (starting with ~). Quotes are separated by blank lines.</p>
<div id="quotesRows"></div>
<button onclick="addQuoteRow()">Add New Quote</button>
<button onclick="loadQuotes()">Load from Device</button>
<button onclick="saveQuotes()">Save to Device</button>
<div id="quotesStatus"></div></div>
<div class="section"><h2>Media Mappings (media.csv)</h2>
<p>Configure image and audio file combinations with optional text overlay settings. Only Image is required. Check the "Next" box to set which item will be displayed next. Click "Show" to display the image and play audio on the panel.</p>
<div class="table-wrapper">
<table id="mediaTable" style="width:100%;border-collapse:collapse;margin:10px 0;min-width:800px;">
<thead><tr style="background:#333;"><th style="padding:10px;text-align:left;width:20%;">Image</th><th style="padding:10px;text-align:left;width:20%;">Audio</th><th style="padding:10px;text-align:left;width:12%;">Foreground</th><th style="padding:10px;text-align:left;width:12%;">Outline</th><th style="padding:10px;text-align:left;width:12%;">Font</th><th style="padding:10px;text-align:center;width:8%;">Next</th><th style="padding:10px;text-align:center;width:8%;">Actions</th><th style="padding:10px;width:8%;"></th></tr></thead>
<tbody id="mediaRows"></tbody>
</table>
</div>
<button onclick="addMediaRow()">Add New Row</button>
<button onclick="loadMedia()">Load from Device</button>
<button onclick="saveMedia()">Save to Device</button>
<div id="mediaStatus"></div></div>
<div class="section"><h2>File Management</h2>
<p>Upload, download, and delete files on the SD card.</p>
<div style="margin:10px 0;"><input type="file" id="fileUpload" style="display:none;" onchange="handleFileSelect(event)"><button onclick="document.getElementById('fileUpload').click()">Upload File</button>
<button onclick="refreshFileList()">Refresh File List</button></div>
<div id="fileList" style="margin:10px 0;">Loading files...</div>
<div id="fileStatus"></div></div>
</div>
<div id="configTab" class="tab-content">
<div class="section"><h2>Device Settings</h2>
<div class="form-group">
<label>Volume (0-100%):</label>
<input type="number" id="volume" min="0" max="100" value="50">
</div>
<div class="form-group">
<label>Sleep Interval (minutes, must be factor of 60):</label>
<input type="number" id="sleepInterval" min="1" max="60" value="1">
</div>
<div class="form-group">
<label>Hour Schedule (check hours when device should wake):</label>
<div style="display:flex;flex-wrap:wrap;gap:10px;margin:10px 0;padding:10px;background:#1a1a1a;border-radius:4px;" id="hourSchedule"></div>
<div style="margin-top:10px;"><button onclick="selectAllHours()">Select All</button>
<button onclick="deselectAllHours()">Deselect All</button>
<button onclick="selectNightHours()">Select Night (6am-11pm)</button>
<button onclick="selectDayHours()">Select Day (11pm-6am)</button></div>
</div>
<button onclick="loadSettings()">Load from Device</button>
<button onclick="saveSettings()">Save to Device</button>
<div id="settingsStatus"></div></div>
<div class="section"><h2>GitHub Pages Web UI Password</h2>
<p>Set a password for the GitHub Pages web UI (MQTT-based interface). This password is used to generate HMAC signatures for secure authentication. The password is never transmitted - only HMAC signatures are sent.</p>
<div class="form-group">
<label>Password (minimum 8 characters):</label>
<input type="password" id="webUIPassword" style="width:300px;padding:8px;border:1px solid #444;border-radius:4px;background:#1a1a1a;color:#e0e0e0;font-family:monospace;" placeholder="Enter password...">
</div>
<div class="form-group">
<label>Confirm Password:</label>
<input type="password" id="webUIPasswordConfirm" style="width:300px;padding:8px;border:1px solid #444;border-radius:4px;background:#1a1a1a;color:#e0e0e0;font-family:monospace;" placeholder="Confirm password...">
</div>
<div id="passwordStatus" style="margin:10px 0;"></div>
<button onclick="checkPasswordStatus()">Check Status</button>
<button onclick="setWebUIPassword()">Set Password</button>
<div id="webUIPasswordStatus"></div></div>
<div class="section"><h2>System Log</h2>
<p>View the current system log file (read-only).</p>
<button onclick="loadLog()">Load Current Log</button>
<button onclick="loadLogArchiveList()">Load Previous Log</button>
<div id="logArchiveList" style="margin-top:10px;"></div>
<div id="logContent" style="margin:10px 0;max-height:600px;overflow-y:auto;background:#1a1a1a;padding:10px;border:1px solid #444;border-radius:4px;font-family:monospace;font-size:12px;white-space:pre-wrap;word-wrap:break-word;color:#e0e0e0;"></div>
<div id="logStatus"></div></div>
</div>
<div id="closeStatus" style="position:fixed;top:60px;right:20px;z-index:1001;"></div>
<div id="otaStatus" style="position:fixed;top:60px;right:20px;z-index:1001;"></div>
<script>
function switchTab(tabName){document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));document.querySelectorAll('.tab-content').forEach(c=>c.classList.remove('active'));event.target.classList.add('active');document.getElementById(tabName+'Tab').classList.add('active');}
function createQuoteRow(quote='',author=''){const row=document.createElement('div');row.className='quote-row';row.dataset.index=document.getElementById('quotesRows').children.length;const quoteDiv=document.createElement('div');quoteDiv.className='quote-text';const quoteInput=document.createElement('textarea');quoteInput.className='quoteInput';quoteInput.value=quote;quoteInput.style.width='100%';quoteInput.style.minHeight='60px';quoteInput.style.padding='5px';quoteInput.style.border='1px solid #444';quoteInput.style.borderRadius='4px';quoteInput.style.boxSizing='border-box';quoteInput.style.fontFamily='monospace';quoteInput.style.fontSize='12px';quoteInput.style.background='#1a1a1a';quoteInput.style.color='#e0e0e0';quoteDiv.appendChild(quoteInput);const authorDiv=document.createElement('div');authorDiv.className='quote-author';const authorInput=document.createElement('input');authorInput.type='text';authorInput.className='authorInput';authorInput.value=author;authorInput.placeholder='~Author Name';authorInput.style.width='100%';authorInput.style.padding='5px';authorInput.style.border='1px solid #444';authorInput.style.borderRadius='4px';authorInput.style.boxSizing='border-box';authorInput.style.background='#1a1a1a';authorInput.style.color='#e0e0e0';authorDiv.appendChild(authorInput);const actionDiv=document.createElement('div');actionDiv.style.textAlign='right';actionDiv.style.marginTop='10px';const delBtn=document.createElement('button');delBtn.className='delete';delBtn.textContent='‚úï';delBtn.title='Delete';delBtn.onclick=function(){row.remove();updateQuoteRowIndices();};actionDiv.appendChild(delBtn);row.appendChild(quoteDiv);row.appendChild(authorDiv);row.appendChild(actionDiv);return row;}
function updateQuoteRowIndices(){const rows=document.querySelectorAll('#quotesRows .quote-row');rows.forEach((row,idx)=>{row.dataset.index=idx;});}
function addQuoteRow(){const container=document.getElementById('quotesRows');container.appendChild(createQuoteRow());}
function loadQuotes(){fetch('/api/quotes').then(r=>r.json()).then(quotes=>{const container=document.getElementById('quotesRows');container.innerHTML='';quotes.forEach(q=>{container.appendChild(createQuoteRow(q.quote||'',q.author||''));});updateQuoteRowIndices();if(container.children.length===0)addQuoteRow();showStatus('quotesStatus','Loaded successfully',false);}).catch(e=>{showStatus('quotesStatus','Error: '+e,true);});}
function saveQuotes(){const rows=document.querySelectorAll('#quotesRows .quote-row');let content='';let hasError=false;let errorMsg='';rows.forEach((row,idx)=>{const quote=row.querySelector('.quoteInput').value.trim();const author=row.querySelector('.authorInput').value.trim();if(quote.length>0&&author.length===0){hasError=true;errorMsg='Quote at row '+(idx+1)+' has no author';}if(quote.length>0||author.length>0){if(quote.length===0&&author.length>0){hasError=true;errorMsg='Row '+(idx+1)+' has author but no quote text';}if(!hasError){content+=quote;content+='\n~';content+=author;content+='\n\n';}}});if(hasError){showStatus('quotesStatus','Error: '+errorMsg,true);return;}const saveData={content:content.trim()};fetch('/api/quotes',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(saveData)}).then(r=>r.json()).then(d=>{showStatus('quotesStatus',d.success?'Saved successfully':'Error: '+d.error,d.success?false:true);if(d.success)loadQuotes();}).catch(e=>showStatus('quotesStatus','Error: '+e,true));}
let imageFiles=[];let audioFiles=[];let fontList=[];let filesLoaded=0;
function checkAndLoadMedia(){if(filesLoaded>=3){loadMedia();}else if(filesLoaded>=2){showStatus('mediaStatus','Warning: Only partial file list loaded',true);}}
function loadFileLists(){filesLoaded=0;fetch('/api/images').then(r=>r.json()).then(f=>{imageFiles=f;filesLoaded++;checkAndLoadMedia();}).catch(e=>{showStatus('mediaStatus','Error loading images: '+e,true);filesLoaded++;checkAndLoadMedia();});fetch('/api/audio').then(r=>r.json()).then(f=>{audioFiles=f;filesLoaded++;checkAndLoadMedia();}).catch(e=>{showStatus('mediaStatus','Error loading audio: '+e,true);filesLoaded++;checkAndLoadMedia();});fetch('/api/fonts').then(r=>r.json()).then(f=>{fontList=f;filesLoaded++;checkAndLoadMedia();}).catch(e=>{showStatus('mediaStatus','Error loading fonts: '+e,true);filesLoaded++;checkAndLoadMedia();});}
let showInProgress=false;
function parseCSVLine(line){const fields=[];let currentField='';let inQuotes=false;for(let i=0;i<line.length;i++){const ch=line[i];if(ch==='"'){if(inQuotes&&i+1<line.length&&line[i+1]==='"'){currentField+='"';i++;}else{inQuotes=!inQuotes;}}else if(ch===','&&!inQuotes){fields.push(currentField);currentField='';}else{currentField+=ch;}}fields.push(currentField);return fields;}
function escapeCSVField(field){if(field.indexOf(',')>=0||field.indexOf('"')>=0||field.indexOf('\n')>=0){return'"'+field.replace(/"/g,'""')+'"';}return field;}
function createMediaRow(image='',audio='',foreground='',outline='',font='',isNext=false){const row=document.createElement('tr');row.dataset.index=document.getElementById('mediaRows').children.length;const imgCell=document.createElement('td');const imgSelect=document.createElement('select');imgSelect.className='imageSelect';imgSelect.style.background='#1a1a1a';imgSelect.style.color='#e0e0e0';imgSelect.style.border='1px solid #444';imgSelect.style.width='100%';imgSelect.innerHTML='<option value="">-- Select Image --</option>';imageFiles.forEach(f=>{const opt=document.createElement('option');opt.value=f;opt.text=f;opt.selected=(f===image);imgSelect.appendChild(opt);});imgCell.appendChild(imgSelect);const audCell=document.createElement('td');const audSelect=document.createElement('select');audSelect.className='audioSelect';audSelect.style.background='#1a1a1a';audSelect.style.color='#e0e0e0';audSelect.style.border='1px solid #444';audSelect.style.width='100%';audSelect.innerHTML='<option value="">(none)</option>';audioFiles.forEach(f=>{const opt=document.createElement('option');opt.value=f;opt.text=f;opt.selected=(f===audio);audSelect.appendChild(opt);});audCell.appendChild(audSelect);const fgCell=document.createElement('td');const fgSelect=document.createElement('select');fgSelect.className='foregroundSelect';fgSelect.style.background='#1a1a1a';fgSelect.style.color='#e0e0e0';fgSelect.style.border='1px solid #444';fgSelect.style.width='100%';fgSelect.innerHTML='<option value="">(default)</option><option value="black"'+(foreground==='black'?' selected':'')+'>Black</option><option value="white"'+(foreground==='white'?' selected':'')+'>White</option><option value="yellow"'+(foreground==='yellow'?' selected':'')+'>Yellow</option><option value="red"'+(foreground==='red'?' selected':'')+'>Red</option><option value="blue"'+(foreground==='blue'?' selected':'')+'>Blue</option><option value="green"'+(foreground==='green'?' selected':'')+'>Green</option>';fgCell.appendChild(fgSelect);const outCell=document.createElement('td');const outSelect=document.createElement('select');outSelect.className='outlineSelect';outSelect.style.background='#1a1a1a';outSelect.style.color='#e0e0e0';outSelect.style.border='1px solid #444';outSelect.style.width='100%';outSelect.innerHTML='<option value="">(default)</option><option value="black"'+(outline==='black'?' selected':'')+'>Black</option><option value="white"'+(outline==='white'?' selected':'')+'>White</option><option value="yellow"'+(outline==='yellow'?' selected':'')+'>Yellow</option><option value="red"'+(outline==='red'?' selected':'')+'>Red</option><option value="blue"'+(outline==='blue'?' selected':'')+'>Blue</option><option value="green"'+(outline==='green'?' selected':'')+'>Green</option>';outCell.appendChild(outSelect);const fontCell=document.createElement('td');const fontSelect=document.createElement('select');fontSelect.className='fontSelect';fontSelect.style.background='#1a1a1a';fontSelect.style.color='#e0e0e0';fontSelect.style.border='1px solid #444';fontSelect.style.width='100%';fontSelect.innerHTML='<option value="">(default - OpenSans)</option>';fontList.forEach(f=>{const opt=document.createElement('option');const fontName=f.name||f.filename||'';opt.value=fontName;opt.text=fontName;opt.selected=(fontName===font);fontSelect.appendChild(opt);});fontCell.appendChild(fontSelect);const nextCell=document.createElement('td');nextCell.style.textAlign='center';const nextCheck=document.createElement('input');nextCheck.type='checkbox';nextCheck.className='nextCheckbox';nextCheck.checked=isNext;nextCheck.onchange=function(){document.querySelectorAll('.nextCheckbox').forEach(cb=>{if(cb!==nextCheck)cb.checked=false;});};nextCell.appendChild(nextCheck);const actionCell=document.createElement('td');actionCell.style.textAlign='center';const showBtn=document.createElement('button');showBtn.className='showBtn';showBtn.textContent='Show';showBtn.style.margin='2px';showBtn.style.padding='4px 8px';showBtn.style.fontSize='12px';showBtn.disabled=showInProgress;showBtn.onclick=function(){if(showInProgress){alert('Another show operation is in progress. Please wait.');return;}const idx=parseInt(row.dataset.index);showMediaItem(idx);};actionCell.appendChild(showBtn);const delCell=document.createElement('td');const delBtn=document.createElement('button');delBtn.className='delete';delBtn.textContent='‚úï';delBtn.title='Delete';delBtn.onclick=function(){row.remove();updateRowIndices();};delCell.appendChild(delBtn);row.appendChild(imgCell);row.appendChild(audCell);row.appendChild(fgCell);row.appendChild(outCell);row.appendChild(fontCell);row.appendChild(nextCell);row.appendChild(actionCell);row.appendChild(delCell);return row;}
function showMediaItem(index){if(showInProgress){return;}showInProgress=true;document.querySelectorAll('.showBtn').forEach(btn=>btn.disabled=true);showStatus('mediaStatus','Displaying image and playing audio (this will take 20-30 seconds)...',false);fetch('/api/media/show?index='+index,{method:'POST'}).then(r=>r.json()).then(d=>{showInProgress=false;document.querySelectorAll('.showBtn').forEach(btn=>btn.disabled=false);if(d.success){showStatus('mediaStatus','Display updated successfully. Next item: '+(d.nextIndex+1),false);loadMedia();}else{showStatus('mediaStatus','Error: '+d.error,true);}}).catch(e=>{showInProgress=false;document.querySelectorAll('.showBtn').forEach(btn=>btn.disabled=false);showStatus('mediaStatus','Error: '+e,true);});}
function updateRowIndices(){const rows=document.querySelectorAll('#mediaRows tr');rows.forEach((row,idx)=>{row.dataset.index=idx;});}
function addMediaRow(){const tbody=document.getElementById('mediaRows');tbody.appendChild(createMediaRow('','','','','',false));}
function loadMedia(){Promise.all([fetch('/api/media').then(r=>r.text()),fetch('/api/media/index').then(r=>r.json())]).then(([content,indexData])=>{const tbody=document.getElementById('mediaRows');tbody.innerHTML='';const lastDisplayedIndex=indexData.index||0;const lines=content.split('\n');let headerRead=false;let dataLines=[];lines.forEach((line,idx)=>{line=line.trim();if(line.length===0||line.startsWith('#'))return;if(!headerRead){headerRead=true;return;}dataLines.push(line);});const mediaCount=dataLines.length;const nextIndex=(lastDisplayedIndex+1)%mediaCount;dataLines.forEach((line,idx)=>{const fields=parseCSVLine(line);const img=fields[0]||'';const aud=fields[1]||'';const fg=fields[2]||'';const out=fields[3]||'';const font=fields[4]||'';const isNext=(idx===nextIndex);tbody.appendChild(createMediaRow(img.trim(),aud.trim(),fg.trim(),out.trim(),font.trim(),isNext));});updateRowIndices();if(tbody.children.length===0)addMediaRow();showStatus('mediaStatus','Loaded successfully',false);}).catch(e=>{showStatus('mediaStatus','Error: '+e,true);});}
function saveMedia(){const rows=document.querySelectorAll('#mediaRows tr');let content='Image,Audio,Foreground,Outline,Font\n';let nextIndex=-1;rows.forEach((row,idx)=>{const img=row.querySelector('.imageSelect').value.trim();const aud=row.querySelector('.audioSelect').value.trim();const fg=row.querySelector('.foregroundSelect').value.trim();const out=row.querySelector('.outlineSelect').value.trim();const font=row.querySelector('.fontSelect').value.trim();const isNext=row.querySelector('.nextCheckbox').checked;if(isNext)nextIndex=idx;if(img.length>0){content+=escapeCSVField(img)+','+escapeCSVField(aud)+','+escapeCSVField(fg)+','+escapeCSVField(out)+','+escapeCSVField(font)+'\n';}});const saveData={content:content,nextIndex:nextIndex>=0?nextIndex:null};fetch('/api/media',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(saveData)}).then(r=>r.json()).then(d=>{showStatus('mediaStatus',d.success?'Saved successfully':'Error: '+d.error,d.success?false:true);if(d.success)loadMedia();}).catch(e=>showStatus('mediaStatus','Error: '+e,true));}
function loadSettings(){fetch('/api/settings').then(r=>r.json()).then(d=>{document.getElementById('volume').value=d.volume;document.getElementById('sleepInterval').value=d.sleepInterval;if(d.hourSchedule){const schedule=d.hourSchedule;document.querySelectorAll('.hourCheckbox').forEach(cb=>{const hour=parseInt(cb.dataset.hour);cb.checked=schedule[hour]==='1'||schedule[hour]===true;});}showStatus('settingsStatus','Loaded successfully',false);}).catch(e=>showStatus('settingsStatus','Error: '+e,true));}
function saveSettings(){const hourSchedule=[];document.querySelectorAll('.hourCheckbox').forEach(cb=>{hourSchedule.push(cb.checked?'1':'0');});const json=JSON.stringify({volume:parseInt(document.getElementById('volume').value),sleepInterval:parseInt(document.getElementById('sleepInterval').value),hourSchedule:hourSchedule.join('')});fetch('/api/settings',{method:'POST',headers:{'Content-Type':'application/json'},body:json}).then(r=>r.json()).then(d=>{showStatus('settingsStatus',d.success?'Saved successfully':'Error: '+d.error,d.success?false:true);if(d.success)loadSettings();}).catch(e=>showStatus('settingsStatus','Error: '+e,true));}
function selectAllHours(){document.querySelectorAll('.hourCheckbox').forEach(cb=>cb.checked=true);}
function deselectAllHours(){document.querySelectorAll('.hourCheckbox').forEach(cb=>cb.checked=false);}
function selectNightHours(){document.querySelectorAll('.hourCheckbox').forEach(cb=>{const hour=parseInt(cb.dataset.hour);cb.checked=(hour>=6&&hour<23);});}
function selectDayHours(){document.querySelectorAll('.hourCheckbox').forEach(cb=>{const hour=parseInt(cb.dataset.hour);cb.checked=(hour>=23||hour<6);});}
function checkPasswordStatus(){fetch('/api/auth/status').then(r=>r.json()).then(d=>{const status=d.password_configured?'Password is configured':'Password is NOT configured';showStatus('webUIPasswordStatus',status,d.password_configured?false:true);}).catch(e=>showStatus('webUIPasswordStatus','Error: '+e,true));}
function setWebUIPassword(){const password=document.getElementById('webUIPassword').value;const confirm=document.getElementById('webUIPasswordConfirm').value;if(password.length===0){showStatus('webUIPasswordStatus','Error: Password cannot be empty',true);return;}if(password.length<8){showStatus('webUIPasswordStatus','Error: Password must be at least 8 characters',true);return;}if(password!==confirm){showStatus('webUIPasswordStatus','Error: Passwords do not match',true);return;}fetch('/api/auth/password',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({password:password})}).then(r=>r.json()).then(d=>{showStatus('webUIPasswordStatus',d.success?d.message||'Password set successfully':'Error: '+d.error,d.success?false:true);if(d.success){document.getElementById('webUIPassword').value='';document.getElementById('webUIPasswordConfirm').value='';checkPasswordStatus();}}).catch(e=>showStatus('webUIPasswordStatus','Error: '+e,true));}
let fileListData=[];let fileListSortCol='name';let fileListSortDir=1;let currentDir='';
function formatDate(timestamp){if(!timestamp||timestamp===0)return'N/A';const d=new Date(timestamp);return d.toLocaleString();}
function sortFileList(col){if(fileListSortCol===col){fileListSortDir*=-1;}else{fileListSortCol=col;fileListSortDir=1;}renderFileList();}
function escapeHtml(str){const div=document.createElement('div');div.textContent=str;return div.innerHTML;}
function escapeJs(str){return str.replace(/\\/g,'\\\\').replace(/'/g,"\\'").replace(/"/g,'\\"').replace(/\n/g,'\\n').replace(/\r/g,'\\r');}
function navigateToDir(dirPath){currentDir=dirPath;refreshFileList();}
function renderFileList(){const list=document.getElementById('fileList');if(fileListData.length===0){list.innerHTML='<p>No files found'+(currentDir?' in '+currentDir:'')+'.</p>';return;}const sorted=fileListData.slice().sort((a,b)=>{let valA,valB;if(fileListSortCol==='name'){valA=a.name.toLowerCase();valB=b.name.toLowerCase();}else if(fileListSortCol==='size'){valA=a.size;valB=b.size;}else if(fileListSortCol==='modified'){valA=a.modified||0;valB=b.modified||0;}return valA<valB?-1*fileListSortDir:valA>valB?1*fileListSortDir:0;});let html='';if(currentDir){const parts=currentDir.split('/').filter(p=>p.length>0);html+='<div style="margin-bottom:10px;padding:8px;background:#333;border-radius:4px;"><span style="cursor:pointer;color:#4CAF50;" onclick="navigateToDir(\'\')">Root</span>';parts.forEach((part,idx)=>{const path=parts.slice(0,idx+1).join('/');html+=` / <span style="cursor:pointer;color:#4CAF50;" onclick="navigateToDir('${path}')">${escapeHtml(part)}</span>`;});html+='</div>';}html+='<table style="width:100%;border-collapse:collapse;"><thead><tr style="background:#333;">';html+=`<th style="padding:8px;text-align:left;cursor:pointer;" onclick="sortFileList('name')">Name ${fileListSortCol==='name'?(fileListSortDir>0?'‚ñ≤':'‚ñº'):''}</th>`;html+=`<th style="padding:8px;text-align:right;cursor:pointer;" onclick="sortFileList('size')">Size ${fileListSortCol==='size'?(fileListSortDir>0?'‚ñ≤':'‚ñº'):''}</th>`;html+=`<th style="padding:8px;text-align:left;cursor:pointer;" onclick="sortFileList('modified')">Last Modified ${fileListSortCol==='modified'?(fileListSortDir>0?'‚ñ≤':'‚ñº'):''}</th>`;html+='<th style="padding:8px;text-align:center;width:200px;">Actions</th></tr></thead><tbody>';sorted.forEach(f=>{const size=f.isDir?'&lt;DIR&gt;':f.size>=1024*1024?(f.size/(1024*1024)).toFixed(2)+' MB':f.size>=1024?(f.size/1024).toFixed(2)+' KB':f.size+' B';const modified=formatDate(f.modified);const nameEscaped=escapeJs(f.name);const pathEscaped=escapeJs(f.path);const nameHtml=escapeHtml(f.name);if(f.isDir){html+=`<tr><td style="padding:8px;"><span style="cursor:pointer;color:#4CAF50;font-weight:bold;" onclick="navigateToDir('${pathEscaped}')">üìÅ ${nameHtml}</span></td><td style="padding:8px;text-align:right;">${size}</td><td style="padding:8px;">${modified}</td><td style="padding:8px;text-align:center;"><button onclick="renameFile('${pathEscaped}','${nameEscaped}')" style="margin:2px;padding:4px 8px;font-size:12px;">Rename</button><button onclick="deleteFile('${pathEscaped}')" class="delete" title="Delete">‚úï</button></td></tr>`;}else{html+=`<tr><td style="padding:8px;">${nameHtml}</td><td style="padding:8px;text-align:right;">${size}</td><td style="padding:8px;">${modified}</td><td style="padding:8px;text-align:center;"><button onclick="downloadFile('${pathEscaped}')" style="margin:2px;padding:4px 8px;font-size:12px;">Download</button><button onclick="renameFile('${pathEscaped}','${nameEscaped}')" style="margin:2px;padding:4px 8px;font-size:12px;">Rename</button><button onclick="deleteFile('${pathEscaped}')" class="delete" title="Delete">‚úï</button></td></tr>`;}});html+='</tbody></table>';list.innerHTML=html;}
function refreshFileList(){const url=currentDir?'/api/files?dir='+encodeURIComponent(currentDir):'/api/files';fetch(url).then(r=>r.json()).then(files=>{fileListData=files;fileListSortCol='name';fileListSortDir=1;renderFileList();showStatus('fileStatus','File list refreshed',false);}).catch(e=>{showStatus('fileStatus','Error loading files: '+e,true);});}
function downloadFile(filepath){window.location.href='/api/files/'+encodeURIComponent(filepath);showStatus('fileStatus','Downloading '+filepath,false);}
function deleteFile(filepath){const name=filepath.split('/').pop();if(confirm('Delete '+name+'?')){fetch('/api/files/'+encodeURIComponent(filepath),{method:'DELETE'}).then(r=>r.json()).then(d=>{showStatus('fileStatus',d.success?'Deleted successfully':'Error: '+d.error,d.success?false:true);if(d.success)refreshFileList();}).catch(e=>showStatus('fileStatus','Error: '+e,true));}}
function renameFile(filepath,oldName){const newName=prompt('Enter new name:',oldName);if(newName&&newName!==oldName){fetch('/api/files/'+encodeURIComponent(filepath),{method:'PUT',headers:{'Content-Type':'application/json'},body:JSON.stringify({newname:newName})}).then(r=>r.json()).then(d=>{showStatus('fileStatus',d.success?'Renamed successfully':'Error: '+d.error,d.success?false:true);if(d.success)refreshFileList();}).catch(e=>showStatus('fileStatus','Error: '+e,true));}}
function uploadFileChunked(file,base64Data,chunkSize){const totalChunks=Math.ceil(base64Data.length/chunkSize);let uploadedChunks=0;function uploadChunk(index){const start=index*chunkSize;const end=Math.min(start+chunkSize,base64Data.length);const chunk=base64Data.substring(start,end);const payload=JSON.stringify({filename:file.name,chunkIndex:index,totalChunks:totalChunks,chunkData:chunk});fetch('/api/files/upload/chunk',{method:'POST',headers:{'Content-Type':'application/json'},body:payload}).then(r=>r.json()).then(d=>{if(d.success){uploadedChunks++;const progress=Math.round((uploadedChunks/totalChunks)*100);showStatus('fileStatus','Uploading '+file.name+'... '+progress+'%',false);if(uploadedChunks<totalChunks){uploadChunk(uploadedChunks);}else{showStatus('fileStatus','Uploaded successfully ('+d.size+' bytes)',false);refreshFileList();document.getElementById('fileUpload').value='';}}else{showStatus('fileStatus','Error: '+d.error,true);}}).catch(e=>{showStatus('fileStatus','Error uploading chunk: '+e,true);});}uploadChunk(0);}
function handleFileSelect(event){const file=event.target.files[0];if(!file)return;showStatus('fileStatus','Reading '+file.name+'...',false);const reader=new FileReader();reader.onload=function(e){const base64Data=e.target.result;const base64Content=base64Data.substring(base64Data.indexOf(',')+1);const decodedSizeKB=(base64Content.length*3/4/1024).toFixed(1);const base64SizeKB=(base64Content.length/1024).toFixed(1);const chunkSize=300*1024;const maxSingleRequestSize=400*1024;const uploadUrl=currentDir?'/api/files/upload?dir='+encodeURIComponent(currentDir):'/api/files/upload';if(base64Content.length>maxSingleRequestSize){showStatus('fileStatus','File is large ('+decodedSizeKB+' KB decoded, '+base64SizeKB+' KB base64), using chunked upload...',false);uploadFileChunked(file,base64Content,chunkSize,currentDir);}else{const payload=JSON.stringify({filename:file.name,data:base64Content});showStatus('fileStatus','Uploading '+file.name+'...',false);fetch(uploadUrl,{method:'POST',headers:{'Content-Type':'application/json'},body:payload}).then(r=>r.json()).then(d=>{showStatus('fileStatus',d.success?'Uploaded successfully ('+d.size+' bytes)':'Error: '+d.error,d.success?false:true);if(d.success){refreshFileList();document.getElementById('fileUpload').value='';}}).catch(e=>{showStatus('fileStatus','Error: '+e,true);});}};reader.onerror=function(e){showStatus('fileStatus','Error reading file',true);};reader.readAsDataURL(file);}
function uploadFileChunked(file,base64Data,chunkSize,uploadDir=''){const totalChunks=Math.ceil(base64Data.length/chunkSize);let uploadedChunks=0;const uploadUrl=uploadDir?'/api/files/upload/chunk?dir='+encodeURIComponent(uploadDir):'/api/files/upload/chunk';function uploadChunk(index){const start=index*chunkSize;const end=Math.min(start+chunkSize,base64Data.length);const chunk=base64Data.substring(start,end);const payload=JSON.stringify({filename:file.name,chunkIndex:index,totalChunks:totalChunks,chunkData:chunk});fetch(uploadUrl,{method:'POST',headers:{'Content-Type':'application/json'},body:payload}).then(r=>r.json()).then(d=>{if(d.success){uploadedChunks++;const progress=Math.round((uploadedChunks/totalChunks)*100);showStatus('fileStatus','Uploading '+file.name+'... '+progress+'%',false);if(uploadedChunks<totalChunks){uploadChunk(uploadedChunks);}else{showStatus('fileStatus','Uploaded successfully ('+d.size+' bytes)',false);refreshFileList();document.getElementById('fileUpload').value='';}}else{showStatus('fileStatus','Error: '+d.error,true);}}).catch(e=>{showStatus('fileStatus','Error uploading chunk: '+e,true);});}uploadChunk(0);}
function loadLog(){logFlush();fetch('/api/log').then(r=>r.text()).then(content=>{document.getElementById('logContent').textContent=content;showStatus('logStatus','Log loaded',false);}).catch(e=>{showStatus('logStatus','Error loading log: '+e,true);document.getElementById('logContent').textContent='Error: '+e;});}
function loadLogArchiveList(){fetch('/api/log/list').then(r=>r.json()).then(files=>{const listDiv=document.getElementById('logArchiveList');if(files.length===0){listDiv.innerHTML='<p style="color:#999;">No archived log files found. Log rotation has not occurred yet.</p>';return;}let html='<p><strong>Recent archived logs (most recent first):</strong></p><div style="display:flex;flex-direction:column;gap:5px;">';files.forEach((file,idx)=>{const filenameEscaped=file.filename.replace(/"/g,'&quot;').replace(/'/g,'&#39;');html+='<button onclick="loadLogArchive(\''+filenameEscaped+'\')" style="text-align:left;padding:8px;">'+file.filename+' ('+formatFileSize(file.size)+')</button>';});html+='</div>';listDiv.innerHTML=html;showStatus('logStatus','Found '+files.length+' archived log file(s)',false);}).catch(e=>{showStatus('logStatus','Error loading archive list: '+e,true);document.getElementById('logArchiveList').innerHTML='<p style="color:red;">Error: '+e+'</p>';});}
function loadLogArchive(filename){const url=filename?'/api/log/archive?file='+encodeURIComponent(filename):'/api/log/archive';fetch(url).then(r=>{if(!r.ok){return r.text().then(text=>{throw new Error(text);});}return r.text();}).then(content=>{document.getElementById('logContent').textContent=content;showStatus('logStatus',filename?'Archive log loaded: '+filename:'Archive log loaded',false);}).catch(e=>{showStatus('logStatus','Error loading archive: '+e,true);document.getElementById('logContent').textContent='Error: '+e;});}
function formatFileSize(bytes){if(bytes<1024)return bytes+' B';if(bytes<1024*1024)return (bytes/1024).toFixed(1)+' KB';return (bytes/(1024*1024)).toFixed(1)+' MB';}
function logFlush(){fetch('/api/log/flush',{method:'POST'});}
function closeServer(){if(confirm('Close management interface and return to normal operation?')){fetch('/api/close',{method:'POST'}).then(r=>r.json()).then(d=>{showStatus('closeStatus','Management interface closed. You can close this page.',false);setTimeout(()=>{window.location.href='about:blank';},2000);}).catch(e=>showStatus('closeStatus','Error: '+e,true));}}
function startOTA(){if(confirm('Start OTA update mode? The device will listen for firmware updates for 10 minutes. You can then upload firmware to /update endpoint.')){showStatus('otaStatus','Starting OTA server...',false);fetch('/api/ota/start',{method:'POST'}).then(r=>r.json()).then(d=>{if(d.success){showStatus('otaStatus','OTA server started! Upload firmware to: '+d.url,false);}else{showStatus('otaStatus','Error: '+d.error,true);}}).catch(e=>{showStatus('otaStatus','Error: '+e,true);});}}
function displayText(){const text=document.getElementById('textInput').value.trim();if(text.length===0){showStatus('textStatus','Please enter some text',true);return;}const color=document.getElementById('textColor').value;const bgColor=document.getElementById('textBackgroundColor').value;showStatus('textStatus','Displaying text...',false);fetch('/api/text/display',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({text:text,color:color,backgroundColour:bgColor})}).then(r=>r.json()).then(d=>{showStatus('textStatus',d.success?'Text displayed successfully!':'Error: '+d.error,d.success?false:true);}).catch(e=>{showStatus('textStatus','Error: '+e,true);});}
function showStatus(id,msg,isError){const el=document.getElementById(id);el.textContent=msg;el.className=isError?'error status':'status';}
let canvas=document.getElementById('drawCanvas');let ctx=canvas.getContext('2d');let isDrawing=false;let lastX=0;let lastY=0;
const colorMap={0:'#000000',1:'#FFFFFF',2:'#FFFF00',3:'#FF0000',5:'#0000FF',6:'#00FF00'};
function getDrawColor(){const val=parseInt(document.getElementById('drawColor').value);return colorMap[val]||'#000000';}
function startDraw(e){isDrawing=true;const rect=canvas.getBoundingClientRect();lastX=e.clientX?e.clientX-rect.left:e.touches[0].clientX-rect.left;lastY=e.clientY?e.clientY-rect.top:e.touches[0].clientY-rect.top;}
function draw(e){if(!isDrawing)return;e.preventDefault();const rect=canvas.getBoundingClientRect();const x=e.clientX?e.clientX-rect.left:e.touches[0].clientX-rect.left;const y=e.clientY?e.clientY-rect.top:e.touches[0].clientY-rect.top;ctx.strokeStyle=getDrawColor();ctx.lineWidth=2;ctx.lineCap='round';ctx.beginPath();ctx.moveTo(lastX,lastY);ctx.lineTo(x,y);ctx.stroke();lastX=x;lastY=y;}
function stopDraw(){isDrawing=false;}
function clearCanvas(){ctx.fillStyle='#FFFFFF';ctx.fillRect(0,0,800,600);showStatus('canvasStatus','Canvas cleared',false);}
canvas.addEventListener('mousedown',startDraw);canvas.addEventListener('mousemove',draw);canvas.addEventListener('mouseup',stopDraw);canvas.addEventListener('mouseleave',stopDraw);
canvas.addEventListener('touchstart',(e)=>{e.preventDefault();startDraw(e);});canvas.addEventListener('touchmove',(e)=>{e.preventDefault();draw(e);});canvas.addEventListener('touchend',(e)=>{e.preventDefault();stopDraw();});
function quantizeToEinkColors(imageData){const data=imageData.data;const einkColors=[[0,0,0],[255,255,255],[255,255,0],[255,0,0],[0,0,255],[0,255,0]];function findClosestColor(r,g,b){let minDist=Infinity;let closestIdx=0;for(let i=0;i<einkColors.length;i++){const ec=einkColors[i];const dist=Math.pow(r-ec[0],2)+Math.pow(g-ec[1],2)+Math.pow(b-ec[2],2);if(dist<minDist){minDist=dist;closestIdx=i;}}return closestIdx;}for(let i=0;i<data.length;i+=4){const r=data[i];const g=data[i+1];const b=data[i+2];const idx=findClosestColor(r,g,b);const color=einkColors[idx];data[i]=color[0];data[i+1]=color[1];data[i+2]=color[2];}return imageData;}
function sendCanvasToDisplay(){showStatus('canvasStatus','Preparing pixel data...',false);const ctx=canvas.getContext('2d');const imageData=ctx.getImageData(0,0,800,600);const data=imageData.data;const einkColors=[[0,0,0],[255,255,255],[255,255,0],[255,0,0],[0,0,255],[0,255,0]];const einkColorValues=[0,1,2,3,5,6];function findClosestColorIdx(r,g,b){let minDist=Infinity;let closestIdx=0;for(let i=0;i<einkColors.length;i++){const ec=einkColors[i];const dist=Math.pow(r-ec[0],2)+Math.pow(g-ec[1],2)+Math.pow(b-ec[2],2);if(dist<minDist){minDist=dist;closestIdx=i;}}return closestIdx;}const pixelData=[];for(let i=0;i<data.length;i+=4){const r=data[i];const g=data[i+1];const b=data[i+2];const arrayIdx=findClosestColorIdx(r,g,b);const einkColorValue=einkColorValues[arrayIdx];pixelData.push(einkColorValue);}const pixelBytes=new Uint8Array(pixelData);const base64Data=btoa(String.fromCharCode.apply(null,pixelBytes));const sizeKB=(pixelBytes.length/1024).toFixed(1);showStatus('canvasStatus','Sending pixel data ('+sizeKB+' KB)...',false);fetch('/api/canvas/display',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({pixelData:base64Data,width:800,height:600})}).then(r=>r.json()).then(d=>{showStatus('canvasStatus',d.success?'Drawing displayed successfully!':'Error: '+d.error,d.success?false:true);}).catch(e=>{showStatus('canvasStatus','Error: '+e,true);});}
let lastActivityPing=0;const ACTIVITY_PING_INTERVAL=30000;function pingActivity(){const now=Date.now();if(now-lastActivityPing<ACTIVITY_PING_INTERVAL)return;lastActivityPing=now;fetch('/api/activity',{method:'POST'}).catch(()=>{});}
document.addEventListener('click',pingActivity);document.addEventListener('keydown',pingActivity);document.addEventListener('mousemove',()=>{if(Date.now()-lastActivityPing>5000)pingActivity();});document.addEventListener('touchstart',pingActivity);document.addEventListener('scroll',()=>{if(Date.now()-lastActivityPing>5000)pingActivity();});
window.onload=function(){loadQuotes();loadFileLists();loadSettings();refreshFileList();clearCanvas();pingActivity();checkPasswordStatus();for(let i=0;i<24;i++){const cb=document.createElement('input');cb.type='checkbox';cb.className='hourCheckbox';cb.dataset.hour=i;const label=document.createElement('label');label.appendChild(cb);label.appendChild(document.createTextNode(' '+String(i).padStart(2,'0')+':00'));label.style.marginRight='10px';label.style.color='#e0e0e0';document.getElementById('hourSchedule').appendChild(label);}};
</script>
</body>
</html>
